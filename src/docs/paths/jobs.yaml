/api/v1/jobs:
  get:
    tags: [Jobs]
    summary: List jobs (Role-filtered)
    description: |
      List all jobs with visibility filters:
      - **CLIENT:** Sees only jobs for their fleet.
      - **SURVEYOR:** Sees only assigned jobs.
      - **ADMIN/GM/TM/TO:** See all matching jobs.
    operationId: getJobs
    x-roles: [CLIENT, ADMIN, GM, TM, TO, TA, FLAG_ADMIN, SURVEYOR]
    parameters:
      - name: page
        in: query
        schema: { type: integer, default: 1 }
      - name: limit
        in: query
        schema: { type: integer, default: 20 }
      - name: status
        in: query
        schema:
          type: string
          enum: [CREATED, APPROVED, ASSIGNED, SURVEY_AUTHORIZED, IN_PROGRESS, SURVEY_DONE, REVIEWED, FINALIZED, REWORK_REQUESTED, PAYMENT_DONE, CERTIFIED, REJECTED]
    responses:
      "200":
        description: List of jobs
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data:
                  type: array
                  items: { $ref: '#/components/schemas/JobResponse' }
                meta: { $ref: '#/components/schemas/PaginatedMeta' }

  post:
    tags: [Jobs]
    summary: Create job request
    description: CLIENT, ADMIN, GM only. Initializes process from CREATED status.
    operationId: createJob
    x-roles: [CLIENT, ADMIN, GM]
    requestBody:
      required: true
      content:
        application/json:
          schema: { $ref: '#/components/schemas/JobCreateRequest' }
    responses:
      "201":
        description: Job created
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}:
  get:
    tags: [Jobs]
    summary: Get job details
    operationId: getJobById
    x-roles: [CLIENT, ADMIN, GM, TM, TO, SURVEYOR]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    responses:
      "200":
        description: Job details
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}/approve:
  put:
    tags: [Jobs]
    summary: Approve job (Role-specific logic)
    description: |
      Transitions job to next state:
      - **CREATED -> APPROVED** (By ADMIN/GM/TM)
      - **ASSIGNED -> SURVEY_AUTHORIZED** (By TM/TO)
      - **SURVEY_DONE -> REVIEWED** (By TO/TM)
      - **REVIEWED -> FINALIZED** (By TM)
    operationId: approveJob
    x-roles: [ADMIN, GM, TM, TO]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      content:
        application/json:
          schema:
            type: object
            properties:
              remarks: { type: string, example: "Verified. Moving to next stage." }
    responses:
      "200":
        description: Job approved
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}/reject:
  put:
    tags: [Jobs]
    summary: Reject/Cancel job
    operationId: rejectJob
    x-roles: [ADMIN, GM, TM]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      content:
        application/json:
          schema:
            type: object
            properties:
              remarks: { type: string, example: "Rejected due to missing docs." }
    responses:
      "200":
        description: Job rejected
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}/assign:
  put:
    tags: [Jobs]
    summary: Assign surveyor
    description: ADMIN or GM assigns a surveyor. Moves status to ASSIGNED.
    operationId: assignSurveyor
    x-roles: [ADMIN, GM]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      required: true
      content:
        application/json:
          schema: { $ref: '#/components/schemas/AssignSurveyorRequest' }
    responses:
      "200":
        description: Surveyor assigned
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}/reassign:
  put:
    tags: [Jobs]
    summary: Reassign surveyor
    description: GM or TM reassigns to another surveyor with mandatory reason.
    operationId: reassignSurveyor
    x-roles: [GM, TM]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      required: true
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ReassignJobRequest' }
    responses:
      "200":
        description: Job reassigned
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobResponse' }

/api/v1/jobs/{id}/history:
  get:
    tags: [Jobs]
    summary: Job status history & Audit trail
    operationId: getJobHistory
    x-roles: [ADMIN, GM, TM, TO]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    responses:
      "200":
        description: History fetched
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data:
                  type: array
                  items: { $ref: '#/components/schemas/JobHistoryItem' }

/api/v1/jobs/{id}/notes:
  post:
    tags: [Jobs]
    summary: Add internal staff note
    operationId: addInternalNote
    x-roles: [ADMIN, GM, TM, TO]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      required: true
      content:
        application/json:
          schema: { $ref: '#/components/schemas/AddNoteRequest' }
    responses:
      "201":
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobNoteResponse' }

/api/v1/jobs/{id}/messages:
  post:
    tags: [Jobs]
    summary: Send communication (with attachment)
    description: Supports multipart/form-data for files or application/json for text-only.
    operationId: sendJobMessage
    x-roles: [CLIENT, ADMIN, GM, TM, TO, SURVEYOR]
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    requestBody:
      content:
        multipart/form-data:
          schema:
            type: object
            properties:
              content: { type: string }
              attachment: { type: string, format: binary }
    responses:
      "201":
        content:
          application/json:
            schema:
              type: object
              properties:
                success: { type: boolean, example: true }
                data: { $ref: '#/components/schemas/JobMessageResponse' }
